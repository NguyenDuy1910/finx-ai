User Query: {{ user_query }}

{% if conversation_history %}
Previous context:
{% for msg in conversation_history %}
- {{ msg.role }}: {{ msg.content[:200] }}
{% endfor %}
{% endif %}

{% if available_entities %}
Known entities in the knowledge graph:
{% for entity in available_entities %}
- {{ entity.name }} ({{ entity.domain }}): maps to table {{ entity.table_name }}
{% endfor %}
{% endif %}

{% if recent_patterns %}
Recently used query patterns:
{% for pattern in recent_patterns %}
- {{ pattern.intent }}: {{ pattern.query }}
{% endfor %}
{% endif %}

Parse this query into structured components. Return valid JSON only.

